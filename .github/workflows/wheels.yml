name: wheels

on:
  # Build wheels on feature branches and PRs (test only)
  push:
    branches: ["**"]
    tags:
      - 'v*'
  pull_request:
    branches: [master]

  # Publish to GitHub Releases when merged to master
  # Publish to PyPI when tagged
  workflow_dispatch:

env:
  # Ensure uv and just are available in PATH
  UV_CACHE_DIR: ${{ github.workspace }}/.uv-cache

jobs:
  identifiers:
    # GitHub needs to know where .cicd/workflows/identifiers.yml lives at parse time,
    # and submodules aren't included in that context! thus the following does NOT work:
    # uses: ./.cicd/workflows/identifiers.yml
    # we MUST reference the remote repo directly:
    uses: wamp-proto/wamp-cicd/.github/workflows/identifiers.yml@main
    # IMPORTANT: we still need .cicd as a Git submodule in the using repo though!
    # because e.g. identifiers.yml wants to access scripts/sanitize.sh !

  build-wheels:
    name: Build wheels on ${{ matrix.os }} (${{ matrix.arch }})
    needs: identifiers
    runs-on: ${{ matrix.os }}

    env:
      BASE_REPO: ${{ needs.identifiers.outputs.base_repo }}
      BASE_BRANCH: ${{ needs.identifiers.outputs.base_branch }}
      PR_NUMBER: ${{ needs.identifiers.outputs.pr_number }}
      PR_REPO: ${{ needs.identifiers.outputs.pr_repo }}
      PR_BRANCH: ${{ needs.identifiers.outputs.pr_branch }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # =========================================================
          # zlmdb builds binary wheels with compiled LMDB C sources
          # using CFFI on all platforms (required for CPython and PyPy)
          # =========================================================
          # NOTE: Linux x86_64 wheels are built in wheels-docker.yml using
          # manylinux_2_28 containers for proper ABI compliance.
          # Linux ARM64 wheels are built in wheels-arm64.yml.
          # This workflow handles macOS, Windows, and source distribution.
          # =========================================================

          # --- macOS ---
          - os: macos-15 # ✅ GitHub-hosted macOS Apple Silicon (current Macs, fast)
            platform: macos
            arch: arm64

          # --- Windows ---
          - os: windows-2022 # ✅ GitHub-hosted Windows x86_64 (mostly fast)
            platform: windows
            arch: x86_64

          # --- Linux (source distribution only, no wheels) ---
          - os: ubuntu-24.04
            platform: linux
            arch: x86_64
            sdist_only: true  # Only build source distribution, not wheels

    steps:
      # ================================================================
      # PHASE 1: SETUP - Install toolchain (just, uv)
      # ================================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive # CRITICAL: zlmdb needs lmdb-upstream submodule

      # Install just task runner
      - name: Install Just (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/bin
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Install Just (Windows)
        if: runner.os == 'Windows'
        uses: extractions/setup-just@v3
        with:
          just-version: "1.42.3"
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # Install uv package manager
      - name: Install uv (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          source $HOME/.cargo/env
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install uv (Windows)
        if: runner.os == 'Windows'
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.7.19"
          # Disable built-in cache on Windows to avoid symlink issues (EPERM on docs/ai/audit)
          # We use a separate actions/cache step below instead
          enable-cache: false
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify toolchain installation (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          just --version
          uv --version
        shell: bash

      - name: Verify toolchain installation (Windows)
        if: runner.os == 'Windows'
        run: |
          just --version
          uv --version
        shell: pwsh

      - name: Setup uv cache
        uses: actions/cache@v4
        with:
          path: ${{ env.UV_CACHE_DIR }}
          key:
            uv-cache-${{ matrix.platform }}-${{ matrix.arch
            }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-cache-${{ matrix.platform }}-${{ matrix.arch }}-
            uv-cache-${{ matrix.platform }}-

      # ================================================================
      # PHASE 2: BUILD - Build wheels/sdist for each platform
      # ================================================================

      # Build binary wheels with compiled LMDB (macOS and Windows only)
      # Linux wheels are built in wheels-docker.yml using manylinux containers
      - name: Build binary wheels with CFFI+LMDB (macOS)
        if: matrix.platform == 'macos'
        run: |
          # Build binary wheels with compiled LMDB C sources via CFFI
          # This builds wheels for ALL Python environments (CPython + PyPy)
          just build-all
        shell: bash

      - name: Build binary wheels with CFFI+LMDB (Windows)
        if: runner.os == 'Windows'
        run: |
          # Build binary wheels with compiled LMDB C sources via CFFI
          # This is REQUIRED for CPython
          # NOTE: PyPy builds are skipped on Windows due to PyPy JIT compilation issues
          just build cpy314
          just build cpy313
          just build cpy312
          just build cpy311
          Get-ChildItem dist
        shell: pwsh

      - name: Build source distribution (Linux x86_64 only)
        if: matrix.platform == 'linux' && matrix.arch == 'x86_64'
        run: |
          # Build source distribution (only once, on Linux x86_64)
          # Source distributions are platform-independent
          just build-sourcedist
        shell: bash

      # ================================================================
      # PHASE 3: VALIDATION - Validate artifacts (per-OS)
      # Each OS validates its own artifacts with FS sync points
      # ================================================================

      # --- macOS validation ---
      - name: Force file system sync (post-build, pre-validation) - macOS
        if: matrix.platform == 'macos'
        run: |
          echo "======================================================================"
          echo "==> Forcing File System Sync (Post-Build)"
          echo "======================================================================"
          echo ""
          sync
          echo "✅ All buffers flushed to disk"
          echo ""
        shell: bash

      - name: Validate wheels integrity (macOS only)
        if: matrix.platform == 'macos'
        run: |
          set -o pipefail
          echo "======================================================================"
          echo "==> Validating Wheel Integrity (macOS)"
          echo "======================================================================"
          echo ""
          python3 -m pip install --break-system-packages git+https://github.com/pypa/packaging.git
          python3 -m pip install --break-system-packages git+https://github.com/pypa/twine.git
          echo ""

          VALIDATION_FILE="dist/VALIDATION.txt"
          echo "Wheel Validation Results - Build Time (wheels workflow)" > "$VALIDATION_FILE"
          echo "=========================================================" >> "$VALIDATION_FILE"
          echo "" >> "$VALIDATION_FILE"
          echo "Validation Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$VALIDATION_FILE"
          echo "Platform: macOS ARM64 (binary with CFFI+LMDB)" >> "$VALIDATION_FILE"
          echo "Python: $(python3 --version)" >> "$VALIDATION_FILE"
          echo "twine: $(twine --version)" >> "$VALIDATION_FILE"
          echo "" >> "$VALIDATION_FILE"

          HAS_ERRORS=0
          for wheel in dist/*.whl; do
            [ -f "$wheel" ] || continue
            WHEEL_NAME=$(basename "$wheel")
            echo "==> Validating: $WHEEL_NAME"
            echo "" >> "$VALIDATION_FILE"
            echo "Wheel: $WHEEL_NAME" >> "$VALIDATION_FILE"
            echo "---" >> "$VALIDATION_FILE"

            if unzip -t "$wheel" > /dev/null 2>&1; then
              echo "  ✅ ZIP test PASS"
              echo "  ZIP test: PASS" >> "$VALIDATION_FILE"
            else
              echo "  ❌ ZIP test FAIL"
              echo "  ZIP test: FAIL" >> "$VALIDATION_FILE"
              HAS_ERRORS=1
            fi

            if python3 -m zipfile -t "$wheel" > /dev/null 2>&1; then
              echo "  ✅ Python zipfile test PASS"
              echo "  Python zipfile test: PASS" >> "$VALIDATION_FILE"
            else
              echo "  ❌ Python zipfile test FAIL"
              echo "  Python zipfile test: FAIL" >> "$VALIDATION_FILE"
              HAS_ERRORS=1
            fi

            twine check "$wheel" 2>&1 | tee /tmp/twine_output.txt
            if [ ${PIPESTATUS[0]} -eq 0 ] && ! grep -Eqi "ERROR|FAILED" /tmp/twine_output.txt; then
              echo "  ✅ Twine check PASS"
              echo "  Twine check: PASS" >> "$VALIDATION_FILE"
            else
              echo "  ❌ Twine check FAIL"
              echo "  Twine check: FAIL" >> "$VALIDATION_FILE"
              cat /tmp/twine_output.txt >> "$VALIDATION_FILE"
              HAS_ERRORS=1
            fi
            rm -f /tmp/twine_output.txt
          done

          if [ $HAS_ERRORS -eq 1 ]; then
            echo "RESULT: VALIDATION FAILED" >> "$VALIDATION_FILE"
            echo "❌ WHEEL VALIDATION FAILED"
            exit 1
          else
            echo "RESULT: ALL VALIDATIONS PASSED" >> "$VALIDATION_FILE"
            echo "✅ All wheels validated successfully"
          fi
        shell: bash

      - name: Generate SHA256 checksums (macOS only)
        if: matrix.platform == 'macos'
        run: |
          echo "==> Generating SHA256 checksums..."
          sync
          cd dist
          for wheel in *.whl; do
            [ -f "$wheel" ] && openssl sha256 "$wheel" | tee -a CHECKSUMS.sha256
          done
          cat CHECKSUMS.sha256
          cd ..
        shell: bash

      - name: Force file system sync (post-checksum) - macOS
        if: matrix.platform == 'macos'
        run: sync
        shell: bash

      # --- Windows validation ---
      - name: Force file system sync (post-build, pre-validation) - Windows
        if: matrix.platform == 'windows'
        run: |
          Write-Host "======================================================================"
          Write-Host "==> Forcing File System Sync (Post-Build) - Windows"
          Write-Host "======================================================================"
          Write-Host ""
          # Windows equivalent of sync - flush file system buffers
          Write-VolumeCache -DriveLetter C -ErrorAction SilentlyContinue
          [System.GC]::Collect()
          [System.GC]::WaitForPendingFinalizers()
          Write-Host "✅ File system buffers flushed"
          Write-Host ""
        shell: pwsh

      - name: Validate wheels integrity (Windows only)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "======================================================================"
          Write-Host "==> Validating Wheel Integrity (Windows)"
          Write-Host "======================================================================"
          Write-Host ""
          python -m pip install --break-system-packages git+https://github.com/pypa/packaging.git
          python -m pip install --break-system-packages git+https://github.com/pypa/twine.git
          Write-Host ""

          $validationFile = "dist\VALIDATION.txt"
          "Wheel Validation Results - Build Time (wheels workflow)" | Out-File -FilePath $validationFile -Encoding UTF8
          "=========================================================" | Out-File -FilePath $validationFile -Append -Encoding UTF8
          "" | Out-File -FilePath $validationFile -Append -Encoding UTF8
          "Validation Date: $((Get-Date).ToUniversalTime().ToString('yyyy-MM-dd HH:mm:ss UTC'))" | Out-File -FilePath $validationFile -Append -Encoding UTF8
          "Platform: Windows x86_64 (binary with CFFI+LMDB)" | Out-File -FilePath $validationFile -Append -Encoding UTF8
          "Python: $(python --version)" | Out-File -FilePath $validationFile -Append -Encoding UTF8
          "twine: $(twine --version)" | Out-File -FilePath $validationFile -Append -Encoding UTF8
          "" | Out-File -FilePath $validationFile -Append -Encoding UTF8

          $hasErrors = $false
          Get-ChildItem dist\*.whl | ForEach-Object {
            $wheelName = $_.Name
            Write-Host "==> Validating: $wheelName"
            "" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            "Wheel: $wheelName" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            "---" | Out-File -FilePath $validationFile -Append -Encoding UTF8

            # Test 1: ZIP integrity
            try {
              [System.IO.Compression.ZipFile]::OpenRead($_.FullName).Dispose()
              Write-Host "  ✅ ZIP test PASS"
              "  ZIP test: PASS" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            } catch {
              Write-Host "  ❌ ZIP test FAIL"
              "  ZIP test: FAIL" | Out-File -FilePath $validationFile -Append -Encoding UTF8
              $hasErrors = $true
            }

            # Test 2: Python zipfile module
            $zipfileTest = python -m zipfile -t $_.FullName 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "  ✅ Python zipfile test PASS"
              "  Python zipfile test: PASS" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            } else {
              Write-Host "  ❌ Python zipfile test FAIL"
              "  Python zipfile test: FAIL" | Out-File -FilePath $validationFile -Append -Encoding UTF8
              $hasErrors = $true
            }

            # Test 3: twine check
            $twineOutput = twine check $_.FullName 2>&1 | Out-String
            if ($LASTEXITCODE -eq 0 -and $twineOutput -notmatch "ERROR|FAILED") {
              Write-Host "  ✅ Twine check PASS"
              "  Twine check: PASS" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            } else {
              Write-Host "  ❌ Twine check FAIL"
              "  Twine check: FAIL" | Out-File -FilePath $validationFile -Append -Encoding UTF8
              $twineOutput | Out-File -FilePath $validationFile -Append -Encoding UTF8
              $hasErrors = $true
            }
          }

          if ($hasErrors) {
            "RESULT: VALIDATION FAILED" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            Write-Host "❌ WHEEL VALIDATION FAILED"
            exit 1
          } else {
            "RESULT: ALL VALIDATIONS PASSED" | Out-File -FilePath $validationFile -Append -Encoding UTF8
            Write-Host "✅ All wheels validated successfully"
          }
        shell: pwsh

      - name: Generate SHA256 checksums (Windows only)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "==> Generating SHA256 checksums..."
          Set-Location dist
          $checksumFile = "CHECKSUMS.sha256"
          Get-ChildItem *.whl | ForEach-Object {
            $hash = (Get-FileHash -Algorithm SHA256 $_.Name).Hash.ToLower()
            $line = "SHA256($($_.Name))= $hash"
            Write-Host $line
            $line | Out-File -FilePath $checksumFile -Append -Encoding UTF8
          }
          Get-Content $checksumFile
          Set-Location ..
        shell: pwsh

      - name: Force file system sync (post-checksum) - Windows
        if: matrix.platform == 'windows'
        run: |
          Write-VolumeCache -DriveLetter C -ErrorAction SilentlyContinue
          [System.GC]::Collect()
          [System.GC]::WaitForPendingFinalizers()
          Write-Host "✅ File system buffers flushed (post-checksum)"
        shell: pwsh

      # --- Linux validation (source distribution) ---
      - name: Force file system sync (post-build, pre-validation) - Linux
        if: matrix.platform == 'linux'
        run: |
          echo "======================================================================"
          echo "==> Forcing File System Sync (Post-Build) - Linux"
          echo "======================================================================"
          echo ""
          sync
          echo "✅ All buffers flushed to disk"
          echo ""
        shell: bash

      - name: Verify source distribution integrity (Linux x86_64 only)
        if: matrix.platform == 'linux' && matrix.arch == 'x86_64'
        run: |
          echo "======================================================================"
          echo "==> Source Distribution Integrity Verification"
          echo "======================================================================"
          echo ""
          echo "OpenSSL version:"
          openssl version
          echo ""

          for tarball in dist/*.tar.gz; do
            if [ ! -f "$tarball" ]; then
              echo "⚠️  No source distribution found in dist/"
              continue
            fi

            BASENAME=$(basename "$tarball")
            echo "==> Verifying: $BASENAME"
            echo ""

            # Gzip integrity test
            if gzip -tv "$tarball" 2>&1 | tee /tmp/gzip_output.txt; then
              echo "✅ Gzip integrity test PASS"
            else
              echo "❌ Gzip integrity test FAIL"
              cat /tmp/gzip_output.txt
              exit 1
            fi

            # Check for trailing garbage
            if grep -qi "trailing garbage" /tmp/gzip_output.txt; then
              echo "❌ ERROR: Source distribution has trailing garbage!"
              exit 1
            fi
            rm -f /tmp/gzip_output.txt

            # Tar extraction test
            if tar -tzf "$tarball" > /dev/null 2>&1; then
              echo "✅ Tar extraction test PASS"
            else
              echo "❌ Tar extraction test FAIL"
              exit 1
            fi

            # Generate checksum
            openssl sha256 "$tarball"

            echo "✅ $BASENAME verified successfully"
            echo ""
          done

          echo "======================================================================"
          echo "✅ All source distributions verified successfully"
          echo "======================================================================"
        shell: bash

      - name: Verify source distribution installs and works (Linux x86_64 only)
        if: matrix.platform == 'linux' && matrix.arch == 'x86_64'
        run: |
          echo "======================================================================"
          echo "==> Verifying Source Distribution Installs and Works"
          echo "======================================================================"
          echo ""
          echo "This test installs the sdist in a fresh venv and runs smoke tests"
          echo "to verify LMDB CFFI compilation and FlatBuffers work correctly."
          echo ""

          # Find the source distribution
          SDIST=$(ls dist/*.tar.gz 2>/dev/null | head -1)
          if [ -z "$SDIST" ]; then
            echo "❌ No source distribution found in dist/"
            exit 1
          fi

          echo "Testing: $(basename $SDIST)"
          echo ""

          # Run the smoke test via just recipe
          just test-sdist-install "$SDIST"

          echo ""
          echo "======================================================================"
          echo "✅ Source distribution verification PASSED"
          echo "======================================================================"
        shell: bash

      - name: Generate SHA256 checksums (Linux x86_64 only)
        if: matrix.platform == 'linux' && matrix.arch == 'x86_64'
        run: |
          echo "==> Generating SHA256 checksums..."
          sync
          cd dist
          CHECKSUM_FILE="CHECKSUMS.sha256"
          for file in *.tar.gz; do
            [ -f "$file" ] && openssl sha256 "$file" | tee -a "$CHECKSUM_FILE"
          done
          cat "$CHECKSUM_FILE"
          cd ..
        shell: bash

      - name: Force file system sync (post-checksum) - Linux
        if: matrix.platform == 'linux'
        run: sync
        shell: bash

      # ================================================================
      # PHASE 4: METADATA - Generate build metadata (after all validations)
      # This comes AFTER all OS validations/checksums so it can aggregate results
      # ================================================================

      - name: Generate build metadata
        run: |
          BUILD_INFO=dist/build-info.txt

          echo "zlmdb Build Information" > $BUILD_INFO
          echo "=======================" >> $BUILD_INFO
          echo "" >> $BUILD_INFO
          echo "Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $BUILD_INFO
          echo "Platform: ${{ matrix.platform }} ${{ matrix.arch }}" >> $BUILD_INFO
          echo "Runner OS: ${{ runner.os }}" >> $BUILD_INFO
          echo "Workflow: wheels.yml" >> $BUILD_INFO
          echo "" >> $BUILD_INFO

          if [ "${{ matrix.platform }}" = "linux" ]; then
            echo "Build Type: Source Distribution" >> $BUILD_INFO
            echo "Build Method: python -m build --sdist" >> $BUILD_INFO
            echo "" >> $BUILD_INFO
            echo "Source Distributions:" >> $BUILD_INFO
            for sdist in dist/*.tar.gz; do
              [ -f "$sdist" ] && echo "- $(basename "$sdist")" >> $BUILD_INFO
            done
          else
            echo "Build Type: Binary Wheels (CFFI+LMDB)" >> $BUILD_INFO
            echo "Build Method: just build-all / just build" >> $BUILD_INFO
            echo "" >> $BUILD_INFO
            echo "Wheels Built:" >> $BUILD_INFO
            for wheel in dist/*.whl; do
              [ -f "$wheel" ] && echo "- $(basename "$wheel")" >> $BUILD_INFO
            done
          fi

          echo "" >> $BUILD_INFO
          echo "Validation Status:" >> $BUILD_INFO
          if [ -f "dist/VALIDATION.txt" ]; then
            grep "RESULT:" dist/VALIDATION.txt >> $BUILD_INFO || echo "- See VALIDATION.txt" >> $BUILD_INFO
          else
            echo "- Integrity verification passed" >> $BUILD_INFO
          fi

          echo "" >> $BUILD_INFO
          echo "Checksums:" >> $BUILD_INFO
          if [ -f "dist/CHECKSUMS.sha256" ]; then
            echo "- See CHECKSUMS.sha256" >> $BUILD_INFO
          fi

          cat $BUILD_INFO
        shell: bash

      - name: Force file system sync (post-metadata) - macOS
        if: matrix.platform == 'macos'
        run: sync
        shell: bash

      - name: Force file system sync (post-metadata) - Windows
        if: matrix.platform == 'windows'
        run: |
          Write-VolumeCache -DriveLetter C -ErrorAction SilentlyContinue
          [System.GC]::Collect()
          [System.GC]::WaitForPendingFinalizers()
          Write-Host "✅ File system buffers flushed (post-metadata)"
        shell: pwsh

      - name: Force file system sync (post-metadata) - Linux
        if: matrix.platform == 'linux'
        run: sync
        shell: bash

      # ================================================================
      # PHASE 5: LIST & UPLOAD - List artifacts and upload
      # ================================================================

      - name: List built artifacts (macOS)
        if: matrix.platform == 'macos'
        run: |
          echo "Built wheels:"
          ls -la dist/
        shell: bash

      - name: List built artifacts (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Host "Built wheels:"
          Get-ChildItem dist
        shell: pwsh

      - name: List built artifacts (Linux - source distribution only)
        if: matrix.platform == 'linux'
        run: |
          echo "Built source distribution:"
          ls -la dist/
        shell: bash

      - name: Upload wheel artifacts (macOS and Windows only)
        if: matrix.platform != 'linux'
        uses: wamp-proto/wamp-cicd/actions/upload-artifact-verified@main
        with:
          name: wheels-${{ matrix.platform }}-${{ matrix.arch }}
          path: ${{ github.workspace }}/dist/
          retention-days: 30

      - name: Upload source distribution (Linux x86_64 only)
        if: matrix.platform == 'linux' && matrix.arch == 'x86_64'
        uses: wamp-proto/wamp-cicd/actions/upload-artifact-verified@main
        with:
          name: source-distribution
          path: ${{ github.workspace }}/dist/
          retention-days: 30
